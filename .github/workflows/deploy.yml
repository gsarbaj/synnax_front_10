name: Deploy synnax.lt

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  WORKDIR: frontend
  APP_NAME: app_synnax
  RELEASES_DIR: /var/www/synnax/releases
  CURRENT_LINK: /var/www/synnax/current
  SSH_PORT: ${{ vars.SSH_PORT || 22 }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout repo
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKDIR }}/package-lock.json

      - name: üì¶ Install dependencies
        working-directory: ${{ env.WORKDIR }}
        run: npm ci

      - name: üèóÔ∏è Build Next.js (standalone)
        working-directory: ${{ env.WORKDIR }}
        env:
          NODE_ENV: production
        run: |
          echo "${{ secrets.ENV_FILE_PRODUCTION }}" > .env.production
          npm run build

      - name: üìÅ Prepare deploy bundle
        run: |
          mkdir -p deploy_bundle
          rsync -a --delete "$WORKDIR/.next/standalone/" deploy_bundle/
          rsync -a "$WORKDIR/.next/static" deploy_bundle/.next/static
          rsync -a "$WORKDIR/public" deploy_bundle/public || true
          cp "$WORKDIR/.env.production" deploy_bundle/.env.production
          echo "Build $GITHUB_SHA" > deploy_bundle/RELEASE.txt

      - name: üîë Configure SSH
        run: |
          install -m 600 /dev/null ~/.ssh/id_ed25519
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          ssh-keyscan -p ${{ env.SSH_PORT }} -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: üì§ Upload to server
        env:
          TS: ${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          set -eux
          RELEASE_DIR="${{ env.RELEASES_DIR }}/$TS"
          ssh -p "${{ env.SSH_PORT }}" "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" "mkdir -p '$RELEASE_DIR'"
          rsync -e "ssh -p ${{ env.SSH_PORT }}" -az deploy_bundle/ "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:$RELEASE_DIR/"

      - name: üîÅ Switch symlink & restart tmux
        env:
          TS: ${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          set -eux
          RELEASE_DIR="${{ env.RELEASES_DIR }}/${TS}"
          ssh -p "${{ env.SSH_PORT }}" "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" bash -s <<'EOSSH'
            set -e
            CURRENT_LINK="/var/www/synnax/current"
            APP_NAME="app_synnax"

            # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º current ‚Üí –Ω–æ–≤—ã–π —Ä–µ–ª–∏–∑
            ln -sfn "$RELEASE_DIR" "$CURRENT_LINK"

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ tmux
            tmux kill-session -t "$APP_NAME" || true
            cd "$CURRENT_LINK"
            set -a; [ -f .env.production ] && . ./.env.production; set +a
            PORT=3000
            tmux new -d -s "$APP_NAME" "cd '$CURRENT_LINK' && NODE_ENV=production HOST=127.0.0.1 PORT=$PORT node server.js"
          EOSSH

      - name: ‚úÖ Smoke test (optional)
        if: ${{ vars.PUBLIC_URL != '' }}
        run: curl -fsSL --max-time 5 "${{ vars.PUBLIC_URL }}/" >/dev/null