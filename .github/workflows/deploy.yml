name: Deploy synnax.lt

on:
  workflow_dispatch: { }         # –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ Actions
  push:
    branches: [ main ]          # —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –ø—É—à–µ –≤ main

env:
  NODE_VERSION: '20.x'
  WORKDIR: .
  APP_NAME: app_synnax
  RELEASES_DIR: /var/www/synnax/releases
  CURRENT_LINK: /var/www/synnax/current
  SSH_PORT: ${{ vars.SSH_PORT || 22 }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4

      - name: üîé Confirm repo layout
        run: |
          echo "Default branch is main? (—Ç—Ä–∏–≥–≥–µ—Ä –∏–∑ push —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–º–µ–Ω–Ω–æ –¥–ª—è main)"
          ls -la
          [ -f package.json ] || { echo "package.json not found in repo root"; exit 1; }
          [ -f package-lock.json ] || { echo "package-lock.json not found in repo root"; exit 1; }

      - name: üü¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ‚ôªÔ∏è Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ hashFiles('package-lock.json') }}
          restore-keys: npm-

      - name: üì¶ Install deps
        env: { npm_config_cache: ~/.npm }
        run: npm ci

      - name: üîê Create .env.production
        run: printf "%s" "${{ secrets.ENV_FILE_PRODUCTION }}" > .env.production

      - name: üèóÔ∏è Build (Next.js standalone)
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: '1'
        run: npm run build

      - name: üìÅ Pack deploy bundle
        run: |
          set -euxo pipefail
          mkdir -p deploy_bundle
          rsync -a --delete ".next/standalone/" deploy_bundle/
          rsync -a ".next/static" deploy_bundle/.next/static
          rsync -a "public" deploy_bundle/public || true
          cp ".env.production" deploy_bundle/.env.production
          echo "Build $GITHUB_REPOSITORY@$GITHUB_SHA" > deploy_bundle/RELEASE.txt

      - name: üîë Start ssh-agent (load key)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üßæ Add known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ env.SSH_PORT }} -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: üîå Test SSH connectivity
        run: |
          ssh -o StrictHostKeyChecking=yes -p ${{ env.SSH_PORT }} \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" \
            'whoami && echo OK'

      - name: üì§ Upload bundle (new release)
        env:
          TS: ${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          set -euxo pipefail
          RELEASE_DIR="${RELEASES_DIR}/${TS}"
          ssh -p "${SSH_PORT}" "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" "mkdir -p '${RELEASE_DIR}'"
          rsync -e "ssh -p ${SSH_PORT}" -az --delete \
            deploy_bundle/ \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${RELEASE_DIR}/"

      - name: üîÅ Switch symlink + tmux restart
        env:
          TS: ${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          set -euxo pipefail
          RELEASE_DIR="${RELEASES_DIR}/${TS}"
          ssh -p "${SSH_PORT}" "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" \
            CURRENT_LINK="${CURRENT_LINK}" \
            APP_NAME="${APP_NAME}" \
            RELEASE_DIR="${RELEASE_DIR}" \
            'bash -s' <<'EOSSH'
  set -euo pipefail
  [ -d "$RELEASE_DIR" ] || { echo "Release dir missing: $RELEASE_DIR"; exit 1; }
  mkdir -p "$(dirname "$CURRENT_LINK")"
  ln -sfn "$RELEASE_DIR" "$CURRENT_LINK"
  if command -v tmux >/dev/null 2>&1; then
  tmux kill-session -t "$APP_NAME" >/dev/null 2>&1 || true
  else
  echo "tmux not found on server"; exit 1
  fi
  cd "$CURRENT_LINK"
  set -a; [ -f ./.env.production ] && . ./.env.production; set +a
  : "${PORT:=3000}"; : "${HOST:=127.0.0.1}"
  tmux new -d -s "$APP_NAME" "cd '$CURRENT_LINK' && NODE_ENV=production HOST=$HOST PORT=$PORT node server.js"
  tmux ls >/dev/null 2>&1 && echo "tmux session '$APP_NAME' started"
  EOSSH

  - name: ‚úÖ Smoke test
    if: ${{ vars.PUBLIC_URL != '' }}
    run: curl -fsSL --max-time 5 "${{ vars.PUBLIC_URL }}/" >/dev/null