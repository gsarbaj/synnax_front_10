name: Deploy synnax.lt

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  # ---- –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ----
  NODE_VERSION: '20.x'
  WORKDIR: frontend
  APP_NAME: app_synnax
  RELEASES_DIR: /var/www/synnax/releases
  CURRENT_LINK: /var/www/synnax/current
  SSH_PORT: ${{ vars.SSH_PORT || 22 }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) –ö–æ–¥
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4

      # 2) Node + –∫—ç—à npm (–í–ê–ñ–ù–û: –ø—É—Ç—å –¥–æ lock-—Ñ–∞–π–ª–∞ –≤–Ω—É—Ç—Ä–∏ frontend/)
      - name: üü¢ Setup Node (with npm cache)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKDIR }}/package-lock.json

      # 3) –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: üì¶ Install deps (npm ci)
        working-directory: ${{ env.WORKDIR }}
        run: npm ci

      # 4) (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ø—Ä–æ–≤–µ—Ä–∫–∏
      - name: üßπ Lint (non-blocking)
        working-directory: ${{ env.WORKDIR }}
        run: npm run lint || true

      - name: üîé Typecheck (non-blocking)
        working-directory: ${{ env.WORKDIR }}
        run: npm run typecheck || true

      # 5) .env.production –¥–ª—è –±–∏–ª–¥–∞/—Ä–∞–Ω—Ç–∞–π–º–∞
      - name: üîê Create .env.production
        working-directory: ${{ env.WORKDIR }}
        run: printf "%s" "${{ secrets.ENV_FILE_PRODUCTION }}" > .env.production

      # 6) –°–±–æ—Ä–∫–∞ Next.js –≤ —Ä–µ–∂–∏–º–µ standalone
      - name: üèóÔ∏è Build (Next.js standalone)
        working-directory: ${{ env.WORKDIR }}
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: '1'
        run: npm run build

      # 7) –£–ø–∞–∫–æ–≤–∫–∞ –±–∞–Ω–¥–ª–∞ –¥–ª—è –¥–µ–ø–ª–æ—è
      - name: üìÅ Pack deploy bundle
        run: |
          set -euxo pipefail
          mkdir -p deploy_bundle
          rsync -a --delete "$WORKDIR/.next/standalone/" deploy_bundle/
          rsync -a "$WORKDIR/.next/static" deploy_bundle/.next/static
          rsync -a "$WORKDIR/public" deploy_bundle/public || true
          cp "$WORKDIR/.env.production" deploy_bundle/.env.production
          echo "Build $GITHUB_REPOSITORY@$GITHUB_SHA" > deploy_bundle/RELEASE.txt

      # 8) SSH –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
      - name: üîë Configure SSH
        run: |
          install -m 600 /dev/null ~/.ssh/id_ed25519
          printf "%s" "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          ssh-keyscan -p ${{ env.SSH_PORT }} -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts

      # 9) –í—ã–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–≥–æ —Ä–µ–ª–∏–∑–∞
      - name: üì§ Upload bundle to server (new release)
        env:
          TS: ${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          set -euxo pipefail
          RELEASE_DIR="${{ env.RELEASES_DIR }}/$TS"
          ssh -p "${{ env.SSH_PORT }}" "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" "mkdir -p '$RELEASE_DIR'"
          rsync -e "ssh -p ${{ env.SSH_PORT }}" -az --delete \
            deploy_bundle/ "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:$RELEASE_DIR/"

      # 10) –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ current –∏ —Ä–µ—Å—Ç–∞—Ä—Ç tmux
      - name: üîÅ Atomic symlink switch + tmux restart
        env:
          TS: ${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          set -euxo pipefail
          RELEASE_DIR="${{ env.RELEASES_DIR }}/${TS}"
          ssh -p "${{ env.SSH_PORT }}" "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" bash -s <<'EOSSH'
            set -euo pipefail
            CURRENT_LINK="'${CURRENT_LINK}'"
            APP_NAME="'${APP_NAME}'"
            RELEASE_DIR="'${RELEASE_DIR}'"

            # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º current ‚Üí –Ω–æ–≤—ã–π —Ä–µ–ª–∏–∑
            ln -sfn "$RELEASE_DIR" "$CURRENT_LINK"

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ tmux
            tmux kill-session -t "$APP_NAME" || true
            cd "$CURRENT_LINK"

            # –ü–æ–¥–≥—Ä—É–∂–∞–µ–º env (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω –Ω–∞ —Ä–∞–Ω—Ç–∞–π–º–µ)
            set -a
            [ -f ./.env.production ] && . ./.env.production
            set +a

            PORT="${PORT:-3000}"
            HOST="${HOST:-127.0.0.1}"

            # –ó–∞–ø—É—Å–∫ standalone-—Å–µ—Ä–≤–µ—Ä–∞ (node server.js –ª–µ–∂–∏—Ç –≤ standalone)
            tmux new -d -s "$APP_NAME" "cd '$CURRENT_LINK' && NODE_ENV=production HOST=$HOST PORT=$PORT node server.js"
          EOSSH

      # 11) –î—ã–º–æ–≤–æ–π —Ç–µ—Å—Ç (–µ—Å–ª–∏ PUBLIC_URL –∑–∞–¥–∞–Ω)
      - name: ‚úÖ Smoke test
        if: ${{ vars.PUBLIC_URL != '' }}
        run: curl -fsSL --max-time 5 "${{ vars.PUBLIC_URL }}/" >/dev/null