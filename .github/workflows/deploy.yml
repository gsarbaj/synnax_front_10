name: Deploy synnax.lt

on:
  workflow_dispatch: {} # –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ Actions
  push:
    branches: [main] # —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –ø—É—à–µ –≤ main

env:
  NODE_VERSION: "20.x"
  WORKDIR: .
  APP_NAME: app_synnax
  RELEASES_DIR: /var/www/synnax/releases
  CURRENT_LINK: /var/www/synnax/current
  SSH_PORT: ${{ vars.SSH_PORT || 22 }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4

      - name: üîé Confirm repo layout
        run: |
          set -euxo pipefail
          echo "Default branch is main? (—Ç—Ä–∏–≥–≥–µ—Ä –∏–∑ push —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–º–µ–Ω–Ω–æ –¥–ª—è main)"
          ls -la
          [ -f package.json ] || { echo "package.json not found in repo root"; exit 1; }
          [ -f package-lock.json ] || { echo "package-lock.json not found in repo root"; exit 1; }

      - name: üü¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ‚ôªÔ∏è Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ hashFiles('package-lock.json') }}
          restore-keys: npm-

      - name: üì¶ Install deps
        env: { npm_config_cache: ~/.npm }
        run: npm ci

      - name: üîê Create .env.production
        run: printf "%s" "${{ secrets.ENV_FILE_PRODUCTION }}" > .env.production

      - name: üèóÔ∏è Build (Next.js standalone)
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: "1"
        run: npm run build

      - name: üìÅ Pack deploy bundle
        run: |
          set -euxo pipefail
          mkdir -p deploy_bundle
          rsync -a --delete ".next/standalone/" deploy_bundle/
          rsync -a ".next/static" deploy_bundle/.next/static
          rsync -a "public" deploy_bundle/public || true
          cp ".env.production" deploy_bundle/.env.production
          echo "Build $GITHUB_REPOSITORY@$GITHUB_SHA" > deploy_bundle/RELEASE.txt
          # sanity: ensure standalone entry exists
          [ -f deploy_bundle/server.js ] || { echo "server.js not found in bundle (Next.js standalone)"; ls -la deploy_bundle; exit 1; }

      - name: üîë Start ssh-agent (load key)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üßæ Add known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ env.SSH_PORT }} -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: üîå Test SSH connectivity
        run: |
          ssh -o StrictHostKeyChecking=yes -p ${{ env.SSH_PORT }} \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" \
            'whoami && echo OK'

      - name: üì§ Upload bundle (new release)
        env:
          TS: ${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          set -euxo pipefail
          RELEASE_DIR="${RELEASES_DIR}/${TS}"
          ssh -p "${SSH_PORT}" "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" "mkdir -p '${RELEASE_DIR}'"
          rsync -e "ssh -p ${SSH_PORT}" -az --delete \
            deploy_bundle/ \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${RELEASE_DIR}/"

      - name: üîÅ Switch symlink + tmux restart
        env:
          TS: ${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          set -euxo pipefail
          RELEASE_DIR="${RELEASES_DIR}/${TS}"
          ssh -p "${SSH_PORT}" "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" \
            CURRENT_LINK="${CURRENT_LINK}" \
            APP_NAME="${APP_NAME}" \
            RELEASE_DIR="${RELEASE_DIR}" \
            NODE_VERSION="${NODE_VERSION:-}" \
            'bash -s' <<'EOSSH'
              set -euo pipefail
              trap 'echo "FAILED at line $LINENO: $BASH_COMMAND" >&2' ERR

              : "${APP_NAME:?APP_NAME is empty}"
              case "$APP_NAME" in *:*) echo "APP_NAME must not contain ':'"; exit 1;; esac

              [ -d "$RELEASE_DIR" ] || { echo "Release dir missing: $RELEASE_DIR"; exit 1; }

              # Ensure we can write the link directory
              LINK_DIR="$(dirname "$CURRENT_LINK")"
              mkdir -p "$LINK_DIR"
              test -w "$LINK_DIR" || { echo "No write permission to $LINK_DIR"; ls -ld "$LINK_DIR"; exit 1; }

              ln -sfn "$RELEASE_DIR" "$CURRENT_LINK"

              # tmux presence
              command -v tmux >/dev/null 2>&1 || { echo "tmux not found on server"; exit 1; }

              # Prepare env
              cd "$CURRENT_LINK"
              set -a; [ -f ./.env.production ] && . ./.env.production; set +a
              : "${PORT:=3000}"; : "${HOST:=127.0.0.1}"

              # Preload nvm in non-interactive shell so resolve_node can see Node.js
              export NVM_DIR="${NVM_DIR:-"$HOME/.nvm"}"
              if [ -s "$NVM_DIR/nvm.sh" ]; then
                set +u
                . "$NVM_DIR/nvm.sh"
                set -u
                desired="${NODE_VERSION:-}"
                if [ -n "$desired" ]; then
                  desired="${desired/.x/}"
                  if ! nvm version "$desired" >/dev/null 2>&1; then
                    nvm install "$desired"
                  fi
                  nvm use "$desired" >/dev/null 2>&1 || true
                else
                  nvm install --lts >/dev/null 2>&1 || true
                  nvm use --lts >/dev/null 2>&1 || true
                fi
              fi

              # Resolve absolute path to Node.js (supports nvm/asdf/volta/system installs)
              resolve_node() {
                local bin=""
                # 1) PATH
                bin="$(command -v node || true)"
                # 2) nvm (user/system-wide)
                if [ -z "$bin" ]; then
                  for nvm_sh in "$HOME/.nvm/nvm.sh" "/usr/local/nvm/nvm.sh" "/opt/nvm/nvm.sh"; do
                    if [ -s "$nvm_sh" ]; then
                      . "$nvm_sh"
                      nvm use --lts >/dev/null 2>&1 || true
                      bin="$(command -v node || true)"
                      [ -n "$bin" ] && break
                    fi
                  done
                fi
                # 3) newest nvm version if present
                if [ -z "$bin" ] && [ -d "$HOME/.nvm/versions/node" ]; then
                  bin="$(ls -d "$HOME"/.nvm/versions/node/*/bin 2>/dev/null | sort -V | tail -n1)/node"
                fi
                # 4) asdf
                if [ -z "$bin" ] && [ -s "$HOME/.asdf/asdf.sh" ]; then
                  . "$HOME/.asdf/asdf.sh"
                  bin="$(command -v node || true)"
                fi
                # 5) Volta
                if [ -z "$bin" ] && [ -x "$HOME/.volta/bin/node" ]; then
                  bin="$HOME/.volta/bin/node"
                fi
                # 6) Common system locations and nodejs fallback
                if [ -z "$bin" ]; then
                  for p in /usr/bin/node /usr/local/bin/node /snap/bin/node /opt/node/bin/node /usr/bin/nodejs /usr/local/bin/nodejs; do
                    [ -x "$p" ] && { bin="$p"; break; }
                  done
                fi
                printf '%s' "$bin"
              }
              NODE_BIN="$(resolve_node)"
              [ -x "$NODE_BIN" ] || { echo "node not found; install Node.js or expose it in PATH (checked nvm/asdf/volta/system)"; exit 1; }
              echo "Using node: $NODE_BIN"
              "$NODE_BIN" -v

              # Restart tmux session using absolute node path and login shell
              tmux kill-session -t "$APP_NAME" >/dev/null 2>&1 || true
              tmux new -d -s "$APP_NAME" -- bash -lc "cd '$CURRENT_LINK' && export NODE_ENV=production HOST='$HOST' PORT='$PORT'; exec '$NODE_BIN' server.js"

              tmux has-session -t "$APP_NAME" 2>/dev/null && echo "tmux session '$APP_NAME' started" || { echo "tmux session failed"; exit 1; }
          EOSSH

      - name: ‚úÖ Smoke test
        if: ${{ vars.PUBLIC_URL != '' }}
        run: curl -fsSL --max-time 5 "${{ vars.PUBLIC_URL }}/" >/dev/null
