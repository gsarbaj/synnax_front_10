name: Deploy synnax.lt

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  WORKDIR: .
  APP_NAME: app_synnax
  RELEASES_DIR: /var/www/synnax/releases
  CURRENT_LINK: /var/www/synnax/current
  SSH_PORT: ${{ vars.SSH_PORT || 22 }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4

      # (—Ä–∞–∑–æ–≤–æ) –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ lock-—Ñ–∞–π–ª –≤ –∫–æ—Ä–Ω–µ
      - name: üîé Debug paths
        run: |
          ls -la
          [ -f "package-lock.json" ] && echo "package-lock.json FOUND" || (echo "package-lock.json MISSING" && exit 1)

      - name: üü¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # –†—É—á–Ω–æ–π –∫—ç—à npm –ø–æ —Ö—ç—à—É –∫–æ—Ä–Ω–µ–≤–æ–≥–æ package-lock.json
      - name: ‚ôªÔ∏è Cache npm (~/.npm)
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            npm-

      - name: üì¶ Install deps (npm ci)
        env:
          npm_config_cache: ~/.npm
        run: npm ci

      - name: üîê Create .env.production
        run: printf "%s" "${{ secrets.ENV_FILE_PRODUCTION }}" > .env.production

      - name: üèóÔ∏è Build (Next.js standalone)
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: '1'
        run: npm run build

      - name: üìÅ Pack deploy bundle
        run: |
          set -euxo pipefail
          mkdir -p deploy_bundle
          rsync -a --delete ".next/standalone/" deploy_bundle/
          rsync -a ".next/static" deploy_bundle/.next/static
          rsync -a "public" deploy_bundle/public || true
          cp ".env.production" deploy_bundle/.env.production
          echo "Build $GITHUB_REPOSITORY@$GITHUB_SHA" > deploy_bundle/RELEASE.txt

      # ==== SSH auth —á–µ—Ä–µ–∑ ssh-agent (–Ω–∞–¥–µ–∂–Ω–æ) ====
      - name: üîë Start ssh-agent (load SSH_PRIVATE_KEY)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üßæ Add known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ env.SSH_PORT }} -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: üîç Debug ssh-agent keys
        run: ssh-add -l || true

      - name: üîå Test SSH connectivity
        run: |
          ssh -o StrictHostKeyChecking=yes -p ${{ env.SSH_PORT }} \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" \
            'whoami && echo OK'

      # ==== –î–µ–ø–ª–æ–π ====
      - name: üì§ Upload bundle to server (new release)
        env:
          TS: ${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          set -euxo pipefail
          RELEASE_DIR="${{ env.RELEASES_DIR }}/$TS"
          ssh -p "${{ env.SSH_PORT }}" "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" "mkdir -p '$RELEASE_DIR'"
          rsync -e "ssh -p ${{ env.SSH_PORT }}" -az --delete \
            deploy_bundle/ "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:$RELEASE_DIR/"

      - name: üîÅ Atomic symlink switch + tmux restart
        env:
          TS: ${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          set -euxo pipefail
          RELEASE_DIR="${{ env.RELEASES_DIR }}/${TS}"
          ssh -p "${{ env.SSH_PORT }}" "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" bash -s <<'EOSSH'
            set -euo pipefail
            CURRENT_LINK="'${CURRENT_LINK}'"
            APP_NAME="'${APP_NAME}'"
            RELEASE_DIR="'${RELEASE_DIR}'"

            ln -sfn "$RELEASE_DIR" "$CURRENT_LINK"

            tmux kill-session -t "$APP_NAME" || true
            cd "$CURRENT_LINK"
            set -a; [ -f ./.env.production ] && . ./.env.production; set +a

            PORT="${PORT:-3000}"
            HOST="${HOST:-127.0.0.1}"
            tmux new -d -s "$APP_NAME" "cd '$CURRENT_LINK' && NODE_ENV=production HOST=$HOST PORT=$PORT node server.js"
          EOSSH

      - name: ‚úÖ Smoke test
        if: ${{ vars.PUBLIC_URL != '' }}
        run: curl -fsSL --max-time 5 "${{ vars.PUBLIC_URL }}/" >/dev/null