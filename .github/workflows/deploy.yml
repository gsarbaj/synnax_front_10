name: Deploy synnax.lt

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  WORKDIR: frontend
  APP_NAME: app_synnax
  RELEASES_DIR: /var/www/synnax/releases
  CURRENT_LINK: /var/www/synnax/current
  SSH_PORT: ${{ vars.SSH_PORT || 22 }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4

      # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—É—Ç–µ–π (–æ–¥–∏–Ω —Ä–∞–∑ –ø–æ–ª–µ–∑–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å)
      - name: üîé Debug paths
        run: |
          echo "WORKDIR=${{ env.WORKDIR }}"
          ls -la
          echo "----"
          ls -la "${{ env.WORKDIR }}" || true
          echo "----"
          [ -f "${{ env.WORKDIR }}/package-lock.json" ] && echo "package-lock.json FOUND" || (echo "package-lock.json MISSING" && exit 1)

      - name: üü¢ Setup Node (–±–µ–∑ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –∫—ç—à–∞)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # –†—É—á–Ω–æ–π –∫—ç—à npm (–∫–ª—é—á ‚Äî —Ö—ç—à package-lock.json –∏–∑ frontend/)
      # –ï—Å–ª–∏ lock-—Ñ–∞–π–ª –Ω–µ –≤ frontend/, –ø–æ–º–µ–Ω—è–π –ø—É—Ç—å –Ω–∏–∂–µ!
      - name: ‚ôªÔ∏è Cache npm (~/.npm)
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ hashFiles(format('{0}/package-lock.json', env.WORKDIR)) }}
          restore-keys: |
            npm-

      - name: üì¶ Install deps (npm ci)
        working-directory: ${{ env.WORKDIR }}
        env:
          npm_config_cache: ~/.npm
        run: npm ci

      - name: üßπ Lint (non-blocking)
        working-directory: ${{ env.WORKDIR }}
        run: npm run lint || true

      - name: üîé Typecheck (non-blocking)
        working-directory: ${{ env.WORKDIR }}
        run: npm run typecheck || true

      - name: üîê Create .env.production
        working-directory: ${{ env.WORKDIR }}
        run: printf "%s" "${{ secrets.ENV_FILE_PRODUCTION }}" > .env.production

      - name: üèóÔ∏è Build (Next.js standalone)
        working-directory: ${{ env.WORKDIR }}
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: '1'
        run: npm run build

      - name: üìÅ Pack deploy bundle
        run: |
          set -euxo pipefail
          mkdir -p deploy_bundle
          rsync -a --delete "$WORKDIR/.next/standalone/" deploy_bundle/
          rsync -a "$WORKDIR/.next/static" deploy_bundle/.next/static
          rsync -a "$WORKDIR/public" deploy_bundle/public || true
          cp "$WORKDIR/.env.production" deploy_bundle/.env.production
          echo "Build $GITHUB_REPOSITORY@$GITHUB_SHA" > deploy_bundle/RELEASE.txt

      - name: üîë Configure SSH
        run: |
          install -m 600 /dev/null ~/.ssh/id_ed25519
          printf "%s" "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          ssh-keyscan -p ${{ env.SSH_PORT }} -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: üì§ Upload bundle to server (new release)
        env:
          TS: ${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          set -euxo pipefail
          RELEASE_DIR="${{ env.RELEASES_DIR }}/$TS"
          ssh -p "${{ env.SSH_PORT }}" "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" "mkdir -p '$RELEASE_DIR'"
          rsync -e "ssh -p ${{ env.SSH_PORT }}" -az --delete \
            deploy_bundle/ "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:$RELEASE_DIR/"

      - name: üîÅ Atomic symlink switch + tmux restart
        env:
          TS: ${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          set -euxo pipefail
          RELEASE_DIR="${{ env.RELEASES_DIR }}/${TS}"
          ssh -p "${{ env.SSH_PORT }}" "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" bash -s <<'EOSSH'
            set -euo pipefail
            CURRENT_LINK="'${CURRENT_LINK}'"
            APP_NAME="'${APP_NAME}'"
            RELEASE_DIR="'${RELEASE_DIR}'"

            ln -sfn "$RELEASE_DIR" "$CURRENT_LINK"

            tmux kill-session -t "$APP_NAME" || true
            cd "$CURRENT_LINK"
            set -a; [ -f ./.env.production ] && . ./.env.production; set +a

            PORT="${PORT:-3000}"
            HOST="${HOST:-127.0.0.1}"
            tmux new -d -s "$APP_NAME" "cd '$CURRENT_LINK' && NODE_ENV=production HOST=$HOST PORT=$PORT node server.js"
          EOSSH

      - name: ‚úÖ Smoke test
        if: ${{ vars.PUBLIC_URL != '' }}
        run: curl -fsSL --max-time 5 "${{ vars.PUBLIC_URL }}/" >/dev/null